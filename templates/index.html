<!DOCTYPE html>
<html lang="{{ get_locale() }}" dir="{{ 'rtl' if get_locale() == 'ar' else 'ltr' }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='home.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='image-assessment.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='live-video-analysis.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='results.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='test.css') }}">
</head>
<body>
  <nav>
    <a href="{{ url_for('set_language', language='en') }}">English</a> |
    <a href="{{ url_for('set_language', language='ar') }}">العربية</a>
  </nav>

  <script>
    {% if test_env %}
      sessionStorage.setItem('test_env', 'true');
    {% endif %}
  </script>

  <script>
    // Show instructions card only in exam view
    function showInstructionsCard(show) {
      const card = document.getElementById('instructionsCard');
      if (card) card.style.display = show ? 'block' : 'none';
    }
    // Show on exam start, hide on patient form/results
    document.addEventListener('DOMContentLoaded', () => {
      // Hide by default (already set in HTML)
      // Show when exam interface is shown
      const origShowExamInterface = window.showExamInterface;
      window.showExamInterface = function() {
        if (typeof origShowExamInterface === 'function') origShowExamInterface();
        showInstructionsCard(true);
      };
      // Hide when patient form or results are shown
      const origShowResultsPage = window.showResultsPage;
      window.showResultsPage = function() {
        if (typeof origShowResultsPage === 'function') origShowResultsPage();
        showInstructionsCard(false);
      };
      const patientForm = document.getElementById('patientForm');
      if (patientForm) {
        patientForm.addEventListener('submit', () => showInstructionsCard(false));
      }
    });
  </script>

  <!-- Route container -->
  <div id="routeContainer"></div>



  <!-- metrics now inside resultsView -->
  <script type="module">
    import { initializeFacialSymmetryApp } from '{{ url_for('static', filename='js/main.js') }}';

    // Clean SPA router: root route ('/') serves home, #/exam and #/results for other views
    // SPA router: loads partials into #routeContainer
    async function loadRoute(route) {
      const container = document.getElementById('routeContainer');
      if (!container) {
        console.error('Route container not found');
        return;
      }

      let file = '';
      if (route === '') {
        file = 'pages/home.html';
      } else if (route === 'live-video-analysis') {
        file = 'pages/live-video-analysis.html';
      } else if (route === 'results') {
        file = 'pages/results.html';
      } else if (route === 'image-assessment') {
        file = 'pages/image-assessment.html';
      } else {
        console.log(`Unknown route '${route}', redirecting to home`);
        window.location.hash = '';
        return;
      }

      try {
        console.log(`Loading route: ${route}, file: ${file}`);
        const resp = await fetch(file);

        if (!resp.ok) {
          throw new Error(`Failed to fetch ${file}: ${resp.status} ${resp.statusText}`);
        }

        const html = await resp.text();
        container.innerHTML = html;

        // Initialize the app now that the DOM is ready
        initializeFacialSymmetryApp();

        // Execute any script tags in the loaded content
        if (route === 'image-assessment') {
          executeScriptsInContainer(container);
        }

        showInstructionsCard(route === 'live-video-analysis');

        // Fire custom events after views are loaded
        if (route === 'live-video-analysis') {
          window.dispatchEvent(new Event('liveVideoAnalysisViewLoaded'));
        } else if (route === 'results') {
          window.dispatchEvent(new Event('resultsViewLoaded'));
        } else if (route === 'image-assessment') {
          window.dispatchEvent(new Event('imageAssessmentViewLoaded'));
          loadImageAssessmentModule();
        }

        console.log(`Successfully loaded route: ${route}`);
      } catch (e) {
        console.error(`Error loading route ${route}:`, e);
        container.innerHTML = `
          <div style="
            color: #e74c3c;
            text-align: center;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            margin: 20px;
            border-left: 4px solid #e74c3c;
          ">
            <h3>Failed to load view: ${route}</h3>
            <p>Error: ${e.message}</p>
            <button onclick="window.location.hash = ''" style="
              background: #3498db;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 4px;
              cursor: pointer;
            ">Go to Home</button>
          </div>
        `;
      }
    }

    function handleRouteChange() {
      let route = window.location.pathname.replace(/^\//, '');
      if (route === '') route = '';
      else if (route === 'live-video-analysis') route = 'live-video-analysis';
      else if (route === 'results') route = 'results';
      else if (route === 'image-assessment') route = 'image-assessment';
      else route = '';
      console.log(`Route changed to: ${route}, User Agent: ${navigator.userAgent}`);
      loadRoute(route);
    }

    window.addEventListener('popstate', handleRouteChange);
    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM Content Loaded, initializing router');
        handleRouteChange();
    });
    // ... (rest of the script)
  </script>
  <!-- Main application -->
  <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
